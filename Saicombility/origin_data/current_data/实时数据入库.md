# VIN与车牌对照(车辆信息表)
**一. 数据来源： **

（1）数据需求：首次运行的话，将历史所有的车牌号取出并去重，存放入维度表中，然后通过MIS中页面进行一一搜索后，将信息录入到Mysql中；非首次运行，将增量数据存放入维度表中，然后通过MIS中页面进行一一搜索后，将信息录入到Mysql中。

（2）MIS系统登录页面： https://ops.saicmobility.com/cms-static/#/login
     车辆列表查询页面：https://ops.saicmobility.com/cms-static/#/carDriverManage/car/carList

（3）车牌信息表：data_dim.dim_driver_num
```sql
drop table if exists data_dim.dim_driver_num;
CREATE TABLE data_dim.dim_driver_num (
  driver_num varchar(200)  COMMENT '车牌号',
  city_name varchar(200) DEFAULT NULL COMMENT '城市名称',
  update_time varchar(200) DEFAULT NULL COMMENT '最近一次修改时间')
partition by list columns(city_name)
(partition p_shanghai values in ('上海市'),
partition p_suzhou values in ('苏州市'),
partition p_hangzhou values in ('杭州市'),
partition p_zhengzhou values in ('郑州市'),
partition p_ningbo values in ('宁波市'),
partition p_kunshan values in ('昆山市'));

truncate table data_dim.dim_driver_num;
insert into data_dim.dim_driver_num
select t.driver_num,t.city_name,t.update_time
from (select t.driver_num,t.city_name,now() update_time,count(*) cnt 
from data_resource.res_driver_income_report_d t
group by t.driver_num,t.city_name) t;
```

VIN与车牌对照表：data_mid.mid_driver_num_to_vin


```sql
drop table if exists data_mid.mid_driver_num_to_vin;
create table data_mid.mid_driver_num_to_vin
(vin varchar(200) comment '车辆VIN号码',
car_card varchar(200) comment '车辆厂牌',
car_engine_no varchar(200) comment '发动机号',
car_no varchar(200) comment '车辆型号',
car_classfic varchar(200) comment '车辆类型',
car_company varchar(200) comment '所属公司',
contract_no varchar(200) comment '合同编号',
driver_phone varchar(200) comment '所属司机手机号',
driver_num varchar(200) comment '车牌号',
car_status varchar(200) comment '状态',
update_time varchar(200) comment '更新时间')
partition by list columns(update_time)
(partition p_20200110 values in ('2020-01-10'));
```

**二.代码与脚本说明：**

（1）配置文件信息：driver_num_id_config.ini
```text
[web_info]
web_username=tankun
web_password=t123456T
web_loginurl=https://ops.saicmobility.com/cms-static/#/login

web_crashurl=https://ops.saicmobility.com/cms-static/#/carDriverManage/car/carList

[db_info]
db_ip=localhost
db_port=3306
db_username=root
db_password=root

db_sql=select * from data_dim.dim_driver_num;
table_schema=data_mid
table_name=mid_driver_num_to_vin
```
（2）登录MIS系统：输入账户、密码、otp，点击登录
```python
def operate_url(login_url,username,password,otp,info_url):
    driver.get(login_url) #打开url链接
      
    driver.find_elements_by_class_name('ant-tabs-tab')[1].click()    #跳转到SSO登录
    time.sleep(1) #停顿1秒
    
    #输入账号&密码&otp        
    driver.find_elements_by_class_name('ant-input')[2].click()    # 点击用户名输入框
    driver.find_elements_by_class_name('ant-input')[2].clear()    # 清空输入框
    driver.find_elements_by_class_name('ant-input')[2].send_keys(username)   #输入用户名
          
    driver.find_elements_by_class_name('ant-input')[3].click() # 点击密码输入框
    driver.find_elements_by_class_name('ant-input')[3].clear()    # 清空输入框
    driver.find_elements_by_class_name('ant-input')[3].send_keys(password)   #输入密码
      
    driver.find_elements_by_class_name('ant-input')[4].click() # 点击密码输入框
    driver.find_elements_by_class_name('ant-input')[4].clear()    # 清空输入框
    driver.find_elements_by_class_name('ant-input')[4].send_keys(otp) # 点击otp输入框
      
    time.sleep(2)
      
    #采用class定位登陆按钮
    driver.find_elements_by_class_name('ant-btn')[1].click() # 点击“登录”按钮
      
    time.sleep(5)
    
    driver.get(info_url)  #打开url链接      
    time.sleep(1)  #这里必须要暂停数秒，否则网站可能加载补完整
```
（3）通过车牌号，获取VIN信息：
```python
#车辆数据抓取
def crash_info(inpurt_info):
    driver.find_elements_by_class_name('el-input__inner')[3].click() # 点击用户名输入框
    driver.find_elements_by_class_name('el-input__inner')[3].send_keys(Keys.CONTROL,'a') # 全选
    driver.find_elements_by_class_name('el-input__inner')[3].send_keys(Keys.BACK_SPACE) #清空输入框
    driver.find_elements_by_class_name('el-input__inner')[3].send_keys(inpurt_info)  #输入相关信息
    #采用class定位登陆按钮
    driver.find_elements_by_class_name('el-button--primary')[6].click() # 点击“搜索”按钮
    time.sleep(1)
    title_name=[]  #初始化
    data=[]
    for i in range(1,11):
        class_name="el-table_1_column_{}".format(str(i))
        title_name.append(driver.find_elements_by_class_name(class_name)[0].get_attribute("textContent"))        
        data.append(driver.find_elements_by_class_name(class_name)[1].get_attribute("textContent")) 
    data_result=dict(zip(title_name,data))
    return(data_result)
```
（4）将查询信息入库：
```python
if __name__ == '__main__':
    os_path=r"D:\Code\para_config\\"
    config_file="driver_num_id_config.ini"
    
    web_otp="477275"  #验证码
    
    try:
        para_name=read_config(os_path,config_file) #读取配置信息
        mysql_data=export_data(para_name['db_info']['db_ip'],int(para_name['db_info']['db_port']),para_name['db_info']['db_username'],para_name['db_info']['db_password'],para_name['db_info']['db_sql'])
        driver_num_list=mysql_data.read_mysql()  #读取车牌号列表数据
        operation_table_partition(para_name['db_info']['db_ip'],int(para_name['db_info']['db_port']),para_name['db_info']['db_username'],para_name['db_info']['db_password'],para_name['db_info']['table_schema'],para_name['db_info']['table_name'],"p_"+str(datetime.date.today()).replace("-",""))
        operate_url(para_name['web_info']['web_loginurl'],para_name['web_info']['web_username'],para_name['web_info']['web_password'],web_otp,para_name['web_info']['web_crashurl']) #登录MIS系统
        imp_data=""  #初始化
        print("时间{}，开始执行，导入程序:".format(time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time()))))
        for i in range(1,len(driver_num_list)+1):  #编号从1开始
            driver_num=driver_num_list[i].split(",")[0].split("\'")[1]   #取出车牌号
            data_result=crash_info(driver_num)  #获取列表信息
            data_result=list(data_result.values()) #将字典列的值化为list
            data_result.append(str(datetime.date.today())) #list里增加当前时间
            data_result=str(data_result).replace("[","(").replace("]",")")  #list转为str
        #数据入库    
            imp_data=(imp_data+","+data_result).lstrip(',')
            var_sql="insert into "+para_name['db_info']['table_schema']+"."+para_name['db_info']['table_name']+" values %s" %imp_data
            if (1.0*i/10).is_integer() and i > 0 :
                opera_database(para_name['db_info']['db_ip'],int(para_name['db_info']['db_port']),para_name['db_info']['db_username'],para_name['db_info']['db_password'],var_sql,"0")  #数据插入数据库
                imp_data=""
                print("---满10行，提交第"+str(int(i/10))+"次----")
                time.sleep(2)    #停顿1秒
            else:
                pass
        opera_database(para_name['db_info']['db_ip'],int(para_name['db_info']['db_port']),para_name['db_info']['db_username'],para_name['db_info']['db_password'],var_sql,"0")  #数据插入数据库
        print("时间{},总共"+str(i+1)+"行，程序执行完成!~".format(time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time()))))
    
    #关闭浏览器
        driver.quit()
```
（5）脚本信息：op_vin_info_load.py

**三. 其他信息：**

（1）数据信息在数据库样式：

（2）运行周期： 暂定为1月跑一次增量数据
