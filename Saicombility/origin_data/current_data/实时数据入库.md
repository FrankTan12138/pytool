# VIN与车牌对照(车辆信息表)
**一. 数据来源： **

（1）数据需求：首次运行的话，将历史所有的车牌号取出并去重，存放入维度表中，然后通过MIS中页面进行一一搜索后，将信息录入到Mysql中；非首次运行，将增量数据存放入维度表中，然后通过MIS中页面进行一一搜索后，将信息录入到Mysql中。

（2）MIS系统登录页面： https://ops.saicmobility.com/cms-static/#/login
     车辆列表查询页面：https://ops.saicmobility.com/cms-static/#/carDriverManage/car/carList

（3）车牌信息表：data_dim.dim_driver_num
```sql
drop table if exists data_dim.dim_driver_num;
CREATE TABLE data_dim.dim_driver_num (
  driver_num varchar(200)  COMMENT '车牌号',
  city_name varchar(200) DEFAULT NULL COMMENT '城市名称',
  update_time varchar(200) DEFAULT NULL COMMENT '最近一次修改时间')
partition by list columns(city_name)
(partition p_shanghai values in ('上海市'),
partition p_suzhou values in ('苏州市'),
partition p_hangzhou values in ('杭州市'),
partition p_zhengzhou values in ('郑州市'),
partition p_ningbo values in ('宁波市'),
partition p_kunshan values in ('昆山市'));

truncate table data_dim.dim_driver_num;
insert into data_dim.dim_driver_num
select t.driver_num,t.city_name,t.update_time
from (select t.driver_num,t.city_name,now() update_time,count(*) cnt 
from data_resource.res_driver_income_report_d t
group by t.driver_num,t.city_name) t;
```

VIN与车牌对照表：data_mid.mid_driver_num_to_vin


```sql
drop table if exists data_mid.mid_driver_num_to_vin;
create table data_mid.mid_driver_num_to_vin
(vin varchar(200) comment '车辆VIN号码',
car_card varchar(200) comment '车辆厂牌',
car_engine_no varchar(200) comment '发动机号',
car_no varchar(200) comment '车辆型号',
car_classfic varchar(200) comment '车辆类型',
car_company varchar(200) comment '所属公司',
contract_no varchar(200) comment '合同编号',
driver_phone varchar(200) comment '所属司机手机号',
driver_num varchar(200) comment '车牌号',
car_status varchar(200) comment '状态',
update_time varchar(200) comment '更新时间')
partition by list columns(update_time)
(partition p_20200110 values in ('2020-01-10'));
```

**二.代码与脚本说明：**

（1）配置文件信息：driver_num_id_config.ini
```text
[web_info]
web_username=tankun
web_password=t123456T
web_loginurl=https://ops.saicmobility.com/cms-static/#/login

web_crashurl=https://ops.saicmobility.com/cms-static/#/carDriverManage/car/carList

[db_info]
db_ip=localhost
db_port=3306
db_username=root
db_password=root

db_sql=select * from data_dim.dim_driver_num;
table_schema=data_mid
table_name=mid_driver_num_to_vin
```
（2）登录MIS系统：输入账户、密码、otp，点击登录
```python
def operate_url(login_url,username,password,otp,info_url):
    driver.get(login_url) #打开url链接
      
    driver.find_elements_by_class_name('ant-tabs-tab')[1].click()    #跳转到SSO登录
    time.sleep(1) #停顿1秒
    
    #输入账号&密码&otp        
    driver.find_elements_by_class_name('ant-input')[2].click()    # 点击用户名输入框
    driver.find_elements_by_class_name('ant-input')[2].clear()    # 清空输入框
    driver.find_elements_by_class_name('ant-input')[2].send_keys(username)   #输入用户名
          
    driver.find_elements_by_class_name('ant-input')[3].click() # 点击密码输入框
    driver.find_elements_by_class_name('ant-input')[3].clear()    # 清空输入框
    driver.find_elements_by_class_name('ant-input')[3].send_keys(password)   #输入密码
      
    driver.find_elements_by_class_name('ant-input')[4].click() # 点击密码输入框
    driver.find_elements_by_class_name('ant-input')[4].clear()    # 清空输入框
    driver.find_elements_by_class_name('ant-input')[4].send_keys(otp) # 点击otp输入框
      
    time.sleep(2)
      
    #采用class定位登陆按钮
    driver.find_elements_by_class_name('ant-btn')[1].click() # 点击“登录”按钮
      
    time.sleep(5)
    
    driver.get(info_url)  #打开url链接      
    time.sleep(1)  #这里必须要暂停数秒，否则网站可能加载补完整
```
（3）通过车牌号，获取VIN信息：
```python
#车辆数据抓取
def crash_info(inpurt_info):
    driver.find_elements_by_class_name('el-input__inner')[3].click() # 点击用户名输入框
    driver.find_elements_by_class_name('el-input__inner')[3].send_keys(Keys.CONTROL,'a') # 全选
    driver.find_elements_by_class_name('el-input__inner')[3].send_keys(Keys.BACK_SPACE) #清空输入框
    driver.find_elements_by_class_name('el-input__inner')[3].send_keys(inpurt_info)  #输入相关信息
    #采用class定位登陆按钮
    driver.find_elements_by_class_name('el-button--primary')[6].click() # 点击“搜索”按钮
    time.sleep(1)
    title_name=[]  #初始化
    data=[]
    for i in range(1,11):
        class_name="el-table_1_column_{}".format(str(i))
        title_name.append(driver.find_elements_by_class_name(class_name)[0].get_attribute("textContent"))        
        data.append(driver.find_elements_by_class_name(class_name)[1].get_attribute("textContent")) 
    data_result=dict(zip(title_name,data))
    return(data_result)
```
（4）将查询信息入库：
```python
if __name__ == '__main__':
    os_path=r"D:\Code\para_config\\"
    config_file="driver_num_id_config.ini"
    
    web_otp="477275"  #验证码
    
    try:
        para_name=read_config(os_path,config_file) #读取配置信息
        mysql_data=export_data(para_name['db_info']['db_ip'],int(para_name['db_info']['db_port']),para_name['db_info']['db_username'],para_name['db_info']['db_password'],para_name['db_info']['db_sql'])
        driver_num_list=mysql_data.read_mysql()  #读取车牌号列表数据
        operation_table_partition(para_name['db_info']['db_ip'],int(para_name['db_info']['db_port']),para_name['db_info']['db_username'],para_name['db_info']['db_password'],para_name['db_info']['table_schema'],para_name['db_info']['table_name'],"p_"+str(datetime.date.today()).replace("-",""))
        operate_url(para_name['web_info']['web_loginurl'],para_name['web_info']['web_username'],para_name['web_info']['web_password'],web_otp,para_name['web_info']['web_crashurl']) #登录MIS系统
        imp_data=""  #初始化
        print("时间{}，开始执行，导入程序:".format(time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time()))))
        for i in range(1,len(driver_num_list)+1):  #编号从1开始
            driver_num=driver_num_list[i].split(",")[0].split("\'")[1]   #取出车牌号
            data_result=crash_info(driver_num)  #获取列表信息
            data_result=list(data_result.values()) #将字典列的值化为list
            data_result.append(str(datetime.date.today())) #list里增加当前时间
            data_result=str(data_result).replace("[","(").replace("]",")")  #list转为str
        #数据入库    
            imp_data=(imp_data+","+data_result).lstrip(',')
            var_sql="insert into "+para_name['db_info']['table_schema']+"."+para_name['db_info']['table_name']+" values %s" %imp_data
            if (1.0*i/10).is_integer() and i > 0 :
                opera_database(para_name['db_info']['db_ip'],int(para_name['db_info']['db_port']),para_name['db_info']['db_username'],para_name['db_info']['db_password'],var_sql,"0")  #数据插入数据库
                imp_data=""
                print("---满10行，提交第"+str(int(i/10))+"次----")
                time.sleep(2)    #停顿1秒
            else:
                pass
        opera_database(para_name['db_info']['db_ip'],int(para_name['db_info']['db_port']),para_name['db_info']['db_username'],para_name['db_info']['db_password'],var_sql,"0")  #数据插入数据库
        print("时间{},总共"+str(i+1)+"行，程序执行完成!~".format(time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time()))))
    
    #关闭浏览器
        driver.quit()
```
（5）脚本信息：op_vin_info_load.py

**三. 其他信息：**

（1）数据信息在数据库样式：

（2）运行周期： 暂定为1月跑一次增量数据

#  实时看板数据(实时订单看板)

**一. 数据来源：**
(1) 数据链接地址：http://data.saicm.local/dataportal-service/html/main.html?token=cb0df5c802cf11ea8db3525400adfdb9#

(2) json数据地址：http://data.saicm.local/dataportal-service/dashboard/realTime_Order_Kanban?city=%E9%83%91%E5%B7%9E%E5%B8%82&carLevel=210&startTime=2019-09-01&endTime=2019-12-09&_=1575958768244

(3) json参数：city（城市名称选项）、carLevel(车辆类型，抓取这部分默认选择汇总)、starttime(开始日期)、endtime(结束日期)


**二. 操作流程: **
(1)数据下载：从json数据的链接将数据保存到本地，命名为realTime_Order_Kanban_[城市名称]_[统计日期].json

(2)保存路径：D:\实时订单数据\

(3)脚本名称：op_imp_fxco_mysql.py

(4)数据表明：data_resource.res_current_order_info_min

```sql
-- 建表语句
drop table if exists data_resource.res_current_order_info_min;
create table  data_resource.res_current_order_info_min 
(day_id varchar(200) comment '统计日期',
 datetime      varchar(200) comment '统计时间',
 city_name     varchar(200) comment '城市名称',
 onlineDrivers varchar(200) comment '在线司机数',
 listeningDrivers  varchar(200) comment '听单司机数',
 callOrders varchar(200) comment '呼叫订单数',
 demandOrders varchar(200) comment '订单需求数',
 answerOrders varchar(200) comment '应答订单数',
 completeOrders varchar(200) comment '完单数',
 payOrders varchar(200) comment '支付订单数',
 completePaidOrders varchar(200) comment '完成支付订单数')
 partition by list columns(day_id)
(partition  p_20191201 values in ('2019-12-01'));

-- 创建分区
alter table data_resource.res_current_order_info_min add partition (partition p_20190901  values in ('2019-09-01'));
```


**三. 脚本代码说明：**
```python
#json字符串数据读取
def read_json(os_path,file_name,order_list,v_city_name):
    json_data=read_txt(os_path,file_name)  #读取json文本
    dict_data=json.loads(json_data[0])
    order_data=dict_data["data"]
    j=0   #设置初始值
    data_result={}
    for data1 in order_data:
        data_col=""
        for i in range(0,len(data1)):           
            if i == 0:
                data_col="\'"+str(data1[order_list[i]].split(" ")[0])+"\',\'"+str(data1[order_list[i]].split(" ")[1])+"\',\'"+v_city_name+"\'"  
            else:
                data_col=(data_col+","+"\'"+str(data1[order_list[i]])+"\'").strip(",")
        data_col="("+data_col+")"       
        data_result[j]=data_col
        j=j+1
    return(data_result) 
```

**四. 下载数据流程：**

(1) 下载原理：通过selenium模拟用户登录，然后跳转到json数据地址，使用xpath方法读取&#60;pre&#62;&#60;/pre&#62;的数据，写入到本地json文本中。

(2) 代码说明：
```python
#通过selenium模拟登录
def operate_url(url,username,password,otp):

#打开url链接
    driver.get(url)
        
#输入账号&密码&otp        
    driver.find_element_by_id('username').click()    # 点击用户名输入框
    driver.find_element_by_id('username').clear()    # 清空输入框
    driver.find_element_by_id('username').send_keys(username)   #自动输入用户名
        
    driver.find_element_by_id('passwd').click() # 点击密码输入框
    driver.find_element_by_id('passwd').clear()    # 清空输入框
    driver.find_element_by_id('passwd').send_keys(password)   #自动输入密码
    
    driver.find_element_by_id('otp').click() # 点击密码输入框
    driver.find_element_by_id('otp').clear()    # 清空输入框
    driver.find_element_by_id('otp').send_keys(otp) # 点击otp输入框
    
    #采用class定位登陆按钮
    driver.find_element_by_class_name('btn-sm').click() # 点击“登录”按钮
    
    time.sleep(2)
```

```python
#通过xpath读取数据，将数据写入json文件
def down_json(url,os_path,file_name):
    driver.get(current_order_url)
    data = driver.find_element_by_tag_name("pre").get_attribute("textContent")
    print(data)
    print("开始下载：{}".format(os_path+file_name))
    with open(os_path+file_name,"wb+")  as file:
        file.write(data.encode("utf-8"))
    file.close()
    print("下载完成：{}".format(os_path+file_name))
```
