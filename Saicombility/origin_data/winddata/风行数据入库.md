# 02司机出行订单

**一. 数据来源：**

（1）数据链接地址：http://10.129.109.15:3000/api/public/card/ad0d5316-bceb-4151-b82f-e335f1ebc31f/query/xlsx?parameters=%5B%7B%22type%22%3A%22date%2Fall-options%22%2C%22target%22%3A%5B%22dimension%22%2C%5B%22template-tag%22%2C%22date%22%5D%5D%2C%22value%22%3A%222019-12-01%22%7D%5D
 
（2） 数据源格式顺序：日期,城市,车级,平台,冒泡数,冒泡需求数,呼叫订单数,应答订单数,完单数,完单且支付订单数,GMV,订单实付金额, 需求满足率,冒泡呼叫率,应答率,完单率, 订单支付率,单均应答时长（分）,单均预估接驾时长(分),单均实际接驾时长（分）, 单均计费里程（公里）,ASP（单均应付）,单均实付,总取消订单数,应答前乘客取消订单数, 应答前乘客取消率,应答后乘客取消订单数,应答后司机取消订单数,应答后取消率,订单差评率,单均预估接驾里程（公里）,单均实际接驾里程（公里）, 乘客3星及3星以下评价率,乘客4星评价率,乘客5星评价率,乘客6星评价率,升舱订单数,升舱完单占比

（3）脚本代码：
```python
if __name__ == '__main__':
    #参数设置
    v_para_cnt=1  #当前日期向前推几天
    
    os_path="D:\\系统报表\\出行订单报表\\"     #文件路径    
    v_date=str(datetime.date.today() - datetime.timedelta(days=v_para_cnt))
    file_name="运营部-02 出行订单表_" +v_date.replace("-","")+".xlsx"         #文件名称
    
    order_list=['日期','城市','车级','平台','冒泡数','冒泡需求数','呼叫订单数','应答订单数','完单数','完单且支付订单数','GMV','订单实付金额', '需求满足率','冒泡呼叫率','应答率','完单率', \
                '订单支付率','单均应答时长（分）','单均预估接驾时长(分)','单均实际接驾时长（分）', '单均计费里程（公里）','ASP（单均应付）','单均实付','总取消订单数','应答前乘客取消订单数', \
                '应答前乘客取消率','应答后乘客取消订单数','应答后司机取消订单数','应答后取消率','订单差评率','单均预估接驾里程（公里）','单均实际接驾里程（公里）', '乘客3星及3星以下评价率', \
                '乘客4星评价率','乘客5星评价率','乘客6星评价率','升舱订单数','升舱完单占比']
    
    
    sheet_para=0 #默认第一个sheet
    head_para="0"
    var_para="0"
    
    #本地参数    
    var_host_para="localhost"
    var_port_para=3306
    var_user_para="root"
    var_password_para="root"
    
        #数据库目标表
    db_name="data_resource"
    result_table="res_travel_order_report_d" 
    partition_name="p_"+v_date.replace("-","")
    
    url="http://10.129.109.15:3000/api/public/card/ad0d5316-bceb-4151-b82f-e335f1ebc31f/query/xlsx?parameters=%5B%7B%22type%22%3A%22date%2Fall-options%22%2C%22target%22%3A%5B%22dimension%22%2C%5B%22template-tag%22%2C%22date%22%5D%5D%2C%22value%22%3A%22{}%22%7D%5D".format(v_date)  #下载链接url
    

    download_excel(url,os_path,file_name)  #下载数据文件
     
    print("文件名称：{}".format(os_path+file_name))
    print("将数据导入本地mysql")      #数据导入本地mysql
    partition_result=operation_table_partition(var_host_para,var_port_para,var_user_para,var_password_para,db_name,result_table,partition_name)
    if partition_result == 0:
        data=load_localdata(var_host_para,var_port_para,var_user_para,var_password_para,os_path,file_name,db_name,result_table,var_para,"","",head_para,order_list)
        data.imp_excel()
    else:
        traceback.print_exc()
        sys.exit()
      
    time.sleep(2)  #暂停2秒
    
    #删除excel文件
    os.remove(os_path+file_name) 
```

**二. Excel数据入库：**

(1) 原理方式：读取Excel数据，调用Mysql的JDBC驱动，将数据加载到对应的数据表。

(2) 脚本名称：op_imp_yh02_mysql.py

(3) 数据表名称：data_resource.res_travel_order_report_d





# 04司机信息报表

**一. 数据来源**：

(1)  数据链接地址：http://10.129.109.15:3000/api/public/card/69c6d2d8-f89d-4f97-939e-41777adc5a23/query/xlsx?parameters=%5B%7B%22type%22%3A%22date%2Fall-options%22%2C%22target%22%3A%5B%22dimension%22%2C%5B%22template-tag%22%2C%22date%22%5D%5D%2C%22value%22%3A%222019-12-10%22%7D%5D"

(2) 数据源格式顺序：序号、日期、城市名称、车级、累计注册司机数、累计完单司机数、新增注册司机数、有效司机数、新增完单司机数、在线司机数、应答司机数、完单司机数、打开APP未出车司机数、司机在线率、司机人均在线时长(小时)、司机人均计费时长(小时)、计费时长占比、服务时长占比、单均实际接驾时长(分钟)、司机订单应收、司机人均订单应收、司机奖励收入、司机订单数、完单司机在线时长、司机人均奖励收入、司机人均完单数、完单司机TPH（平均每小时、每人接单量）、完单司机IPH（平均每小时、每人流水收入）、完单司机OIPH（平均每小时、每人流水收入）、月完单司机数、打开APP司机数、服务封禁数、风控封禁数、在线时长、计费时长、服务时长、接驾时长、司机收入、额外收入

(3) 脚本代码：
```python
if __name__ == '__main__':
    #参数设置
    v_para_cnt=1   #当前日期向前推几天
    
    os_path="D:\\司机信息报表\\"     #文件路径    
    v_date=str(datetime.date.today() - datetime.timedelta(days=v_para_cnt))
    file_name="运营部-04 司机信息报表_" +v_date.replace("-","")+".xlsx"         #文件名称
    
    order_list=['日期','城市名称','车级','累计注册司机数','累计完单司机数','新增注册司机数','有效司机数','新增完单司机数',\
                '在线司机数','应答司机数','完单司机数','打开APP未出车司机数','司机在线率','司机人均在线时长(小时)','司机人均计费时长(小时)',\
                '计费时长占比','服务时长占比','单均实际接驾时长(分钟)','司机订单应收',\
                '司机人均订单应收','司机奖励收入','司机订单数','完单司机在线时长','司机人均奖励收入','司机人均完单数',\
                '完单司机TPH（平均每小时、每人接单量）','完单司机IPH（平均每小时、每人流水收入）','完单司机OIPH（平均每小时、每人流水收入）',\
                '月完单司机数','打开APP司机数','服务封禁数','风控封禁数',\
                '在线时长','计费时长','服务时长','接驾时长','司机收入','额外收入']
    
    
    sheet_para=0 #默认第一个sheet
    head_para=0
    var_para="0"
    
    #本地参数    
    var_host_para="localhost"
    var_port_para=3306
    var_user_para="root"
    var_password_para="root"
    
    
    #数据库目标表
    db_name="data_resource"
    result_table="res_driver_info_report_d" 
    partition_name="p_"+v_date.replace("-","")
    
    url="http://10.129.109.15:3000/api/public/card/69c6d2d8-f89d-4f97-939e-41777adc5a23/query/xlsx?parameters=%5B%7B%22type%22%3A%22date%2Fall-options%22%2C%22target%22%3A%5B%22dimension%22%2C%5B%22template-tag%22%2C%22date%22%5D%5D%2C%22value%22%3A%22{}%22%7D%5D".format(v_date)  #下载链接url
    

    download_excel(url,os_path,file_name)  #下载数据文件
     
    print("文件名称：{}".format(os_path+file_name))
    print("将数据导入本地mysql")      #数据导入本地mysql
    partition_result=operation_table_partition(var_host_para,var_port_para,var_user_para,var_password_para,db_name,result_table,partition_name)
    if partition_result == 0:
        data=load_localdata(var_host_para,var_port_para,var_user_para,var_password_para,os_path,file_name,db_name,result_table,var_para,"","",head_para,order_list)
        data.imp_excel()
    else:
        traceback.print_exc()
        sys.exit()      
    time.sleep(2)  #暂停2秒           
    #删除excel文件
    os.remove(os_path+file_name) 
```
**二. Excel数据入库**

(1) 原理方式：读取Excel数据，调用Mysql的JDBC驱动，将数据加载到对应的数据表。

(2) 脚本名称：op_imp_yh04_mysql.py

(3) 数据表名称：data_resource.res_driver_info_report_d





# 06司机收入报表



**一.Excel数据顺序格式调整**

(1) **原数据源格式来源**：永洪06数据报表格式(Excel数据顺序)

(2) **原数据源格式顺序：**日期、城市、司机ID、司机姓名、车牌号、车级、司机手机号、司机所属公司、司机状态、司机分类、完单数、预约单完单数、A级订单完单数、B级订单完单数、C级订单完单数、首次出车时间、首单完成日期、司机订单应收、司机订单实收、司机分成收入、预约单分成收入、A级订单分成收入、B级订单分成收入、C级订单分成收入、司机奖励收入、附加费、取消费、司机收入、司机扣款、在线时长（小时）、计费时长(小时）、点火时长(小时)、司机指派完单率、TPH、IPH、OIPH、当日服务分、平均服务分、应答订单数、预约单应答数、应答订单数-A级、应答订单数-B级、应答订单数-C级、司机有责取消订单数、司机有责取消订单数-A级、司机有责取消订单数-B级、司机有责取消订单数-C级、预约单司机有责取消数、指定时段在线时长(小时)、实际单均接驾里程（公里）、早高峰应答订单数、晚高峰应答订单数、平峰应答订单数
(3) **切换后数据源格式来源：**风行大数据门户报表格式(Excel数据顺序)

(4) **切换后数据源格式顺序：**序号、统计日期、城市编码、城市名称、司机id、司机名字、司机车级、司机电话、司机公司名称、司机绑定车辆时间、司机首次完单时间、完单数、A级订单完单量、B级订单完单量、C级订单完单量、司机应收、司机实收、司机分成收入、预约单分成收入、A级订单司机分成收入、B级订单司机分成收入、C级订单司机分成收入、司机奖励收入、附加费、取消费、司机收入、在线时长、计费时长、司机指派完单率、TPH、OIPH、IPH、服务分、应答订单数、A级应答订单数、B级应答订单数、C级应答订单数、司机有责取消订单数、司机有责取消订单数A级、司机有责取消订单数B级、司机有责取消订单数C级、指定时间段在线时长、实际单均接驾里程、早高峰应答订单数、晚高峰应答订单数、平峰应答订单数、当日服务分、司机分类、司机状态、点火时长、预约单应答订单数、预约单完单量、预约单司机有责取消数、司机扣款、车牌号

(5) **切换脚本代码：**
```python
 order_list=['统计日期','城市名称','司机id','司机名字','车牌号','司机车级','司机电话','司机公司名称','司机状态','司机分类','完单数','预约单完单量','A级订单完单量','B级订单完单量','C级订单完单量','司机绑定车辆时间','司机首次完单时间','司机应收','司机实收','司机分成收入','预约单分成收入','A级订单司机分成收入','B级订单司机分成收入','C级订单司机分成收入','司机奖励收入','附加费','取消费','司机收入','司机扣款','在线时长','计费时长','点火时长','司机指派完单率','TPH','IPH','OIPH','当日服务分','服务分','应答订单数','预约单应答订单数','A级应答订单数','B级应答订单数','C级应答订单数','司机有责取消订单数','司机有责取消订单数A级','司机有责取消订单数B级','司机有责取消订单数C级','预约单司机有责取消数','指定时间段在线时长','实际单均接驾里程','早高峰应答订单数','晚高峰应答订单数','平峰应答订单数']

#调整到目标格式
def adjust_excel(os_path,file_name,sheet_para,order_list):
    sheetnames=xlrd.open_workbook(os_path+file_name).sheet_names()   #打开来源数据excel表格
    data=pd.read_excel(os_path+file_name,sheet_name=sheetnames[int(sheet_para)],header=0)   #有标题栏，读取sheet内的数据
    data_order=data[order_list]
    nrows=data_order.columns.size    #EXCEL列数
    ncols=len(data_order)
    #     print(str(ncols) +"\t" +str(nrows))
    data_result={}
    for i in range(0,ncols):
        data_col=""
        for j in range(0,nrows):
            data_col=(data_col+","+"\'"+str(data_order.iloc[i,j]).replace("\n","").replace(" ","")+"\'").strip(",")        
        data_result[i]="("+data_col+")"
    return(data_result)
```

**二. Excel下载方式修改**

(1) **原下载方式：**通过永洪界面下载到D盘，然后移动到D盘下的司机收入文件夹下，并且在文件名后加上日期。

(2) **切换后下载方式：**通过url修改参数的形式进行下载，下载前将文件名重命名为原需求的文件名。

(3) **原文件名称：** 运营部-06 司机收入报表_[当天的日期]（例如：20191202）

(4) **下载数据代码：**
```python
#下载数据url链接
url="http://10.129.109.15:3000/api/public/card/0504072d-d8f3-413d-a2f9-a02f1e946bb3/query/xlsx?parameters=%5B%7B%22type%22%3A%22date%2Fall-options%22%2C%22target%22%3A%5B%22dimension%22%2C%5B%22template-tag%22%2C%22date%22%5D%5D%2C%22value%22%3A%22past{}days%22%7D%5D".format(v_para_cnt)

#下载相关数据文件
def download_excel(url,os_path,file_name):
    print("开始下载：{}".format(file_name))
    try:
        urllib.request.urlretrieve(url,os_path+file_name)  #下载文件，并保存到指定文件夹
        print("下载完成：{}".format(file_name))
    except:
        traceback.print_exc()
        sys.exit()
```
**三. Excel数据入库**

(1) **原理方式：**读取Excel数据，调用Mysql的JDBC驱动，将数据加载到对应的数据表。

(2) **脚本调整：**剔除原修改文件和移动指定的目标文件夹的命令，替换成下载数据，替换方法参看第二部分**[Excel下载方式修改]**。

(3) **脚本名称：** op_imp_yh06_mysql.py（沿用之前的脚本名称）




# 24司机分层报表

**一. 数据来源：**

（1）数据链接地址：http://10.129.109.15:3000/api/public/card/f971e1eb-7060-4f7f-9d54-77ba29d1885c/query/xlsx?parameters=%5B%7B%22type%22%3A%22date%2Fall-options%22%2C%22target%22%3A%5B%22dimension%22%2C%5B%22template-tag%22%2C%22date%22%5D%5D%2C%22value%22%3A%22past{}days%7E%22%7D%2C%7B%22type%22%3A%22category%22%2C%22target%22%3A%5B%22dimension%22%2C%5B%22template-tag%22%2C%22city%22%5D%5D%2C%22value%22%3A{}%7D%5D".format(v_para_cnt,city_name)

（2）数据源格式顺序：统计日期,城市,司机分层,司机数量,完单数量,司机总收入,总订单分成收入,总奖励收入,TPH,IPH,单位小时奖励收入,奖励收入占比,人均完单数,人均在线时长,人均司机总收入,人均订单分成收入,人均司机奖励收入]

（3）脚本代码：
```python
if __name__ == '__main__':
    #参数设置
    v_para_cnt=1  #当前日期向前推几天
    
    os_path="D:\\系统报表\\司机分层数据报表\\"     #文件路径    
    v_date=str(datetime.date.today() - datetime.timedelta(days=v_para_cnt))
    file_name="运营部-24 司机分层数据报表_" +v_date.replace("-","")+".xlsx"         #文件名称
    
    order_list=['统计日期','城市','司机分层','司机数量','完单数量','司机总收入','总订单分成收入','总奖励收入','TPH','IPH','单位小时奖励收入','奖励收入占比','人均完单数','人均在线时长','人均司机总收入','人均订单分成收入','人均司机奖励收入']
    city_name_list=['全国','上海市','杭州市','苏州市','宁波市','郑州市']
    city_name=quote("[\""+"\",\"".join(city_name_list)+"\"]")
    
    url ="http://10.129.109.15:3000/api/public/card/f971e1eb-7060-4f7f-9d54-77ba29d1885c/query/xlsx?parameters=%5B%7B%22type%22%3A%22date%2Fall-options%22%2C%22target%22%3A%5B%22dimension%22%2C%5B%22template-tag%22%2C%22date%22%5D%5D%2C%22value%22%3A%22past{}days%7E%22%7D%2C%7B%22type%22%3A%22category%22%2C%22target%22%3A%5B%22dimension%22%2C%5B%22template-tag%22%2C%22city%22%5D%5D%2C%22value%22%3A{}%7D%5D".format(v_para_cnt,city_name)

    sheet_para=0 #默认第一个sheet
    head_para="0"
    var_para="0"
    
    #本地参数    
    var_host_para="localhost"
    var_port_para=3306
    var_user_para="root"
    var_password_para="root"
    
        #数据库目标表
    db_name="data_resource"
    result_table="res_driver_classfic_info_report_d" 
    partition_name="p_"+v_date.replace("-","")
    
    
    

    download_excel(url,os_path,file_name)  #下载数据文件
      
    print("文件名称：{}".format(os_path+file_name))
    print("将数据导入本地mysql")      #数据导入本地mysql
    partition_result=operation_table_partition(var_host_para,var_port_para,var_user_para,var_password_para,db_name,result_table,partition_name)
    if partition_result == 0:
        data=load_localdata(var_host_para,var_port_para,var_user_para,var_password_para,os_path,file_name,db_name,result_table,var_para,"","",head_para,order_list)
        data.imp_excel()
    else:
        traceback.print_exc()
        sys.exit()
       
    time.sleep(2)  #暂停2秒
     
    #删除excel文件
    os.remove(os_path+file_name) 
```

**二. Excel数据入库：**

(1) 原理方式：读取Excel数据，调用Mysql的JDBC驱动，将数据加载到对应的数据表。

(2) 脚本名称：op_imp_yh24_mysql.py

(3) 数据表名称：data_resource.res_driver_classfic_info_report_d

